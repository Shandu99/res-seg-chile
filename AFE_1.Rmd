---
title: "Análisis factorial exploratorio versión 1"
author: "Mauricio Fuentes & Sandra Flors Alvarado"
date: "23/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Estadísitica descriptiva de los indicadores

Se trabajó con la matriz de indicadores **matriz indices seg.RData**, que contiene los 20 índices de segregación para 298 zonas censales. Las medidas de resumen más importantes se muestran a continuación:

```{r, include=FALSE}
rm(list = ls()); gc()
#setwd("/2021-1 UI Segregación/R")
load("matriz indices seg mayores25.RData")
```

```{r}
library(e1071)

indice <- seq(1:20)
nombre <- c(  # Uneveness
     "Dissimilarity",
     "Giny", 
     "Entropy", 
     "Atkinson (b = 0.1)",
     "Atkinson (b = 0.5)",
     "Atkinson (b = 0.9)",
  # Exposure
     "Interaction",
     "Isolation",
     "Correlation", 
  # Concentration
     "Delta", 
     "Absolute concentration",
     "Relative concentration",
  # Centralization
     "Proportion in central city", 
     "Absolute centralization", 
     "Relative centralization", 
  # Clustering
     "Absolute clustering", 
     "Spatial proximity", 
     "Relative clustering", 
     "Distance decay interaction",
     "Distance decay isolation" 
)

datos <- data.frame(res)
mean <- round(as.numeric(lapply(datos, mean, na.rm = TRUE)), digits = 4)
median <- round(as.numeric(lapply(datos, median, na.rm = TRUE)), digits = 4)
min <- round(as.numeric(lapply(datos, min, na.rm = TRUE)), digits = 4)
max <- round(as.numeric(lapply(datos, max, na.rm = TRUE)), digits = 4)
sd <- round(as.numeric(lapply(datos, sd, na.rm = TRUE)), digits = 4)
skewness <- round(as.numeric(lapply(datos, skewness, na.rm = TRUE)), digits = 4)
kurtosis <- round(as.numeric(lapply(datos, kurtosis, na.rm = TRUE)), digits = 4)
n <- nrow(datos) - colSums(is.na(datos)) 
  

tabla <- cbind(indice, nombre, min, mean, median, max, sd, skewness, kurtosis, n)
colnames(tabla) <- c("Índice", "Nombre", "Mínimo", "Media", "Mediana", "Máximo", "Desviación estándar", "Asimetría", "Curtosis", "Número de comunas")
rownames(tabla) <- rep("", 20)

knitr::kable(tabla)
```

Histogramas:

```{r, error=FALSE, message=FALSE, warning=FALSE}
library(reshape)
library(ggplot2)

colnames(datos) <- nombre
datos$ID <- 1:length(datos[[1]])
datos.long <- melt(datos, id = "ID")
colnames(datos.long) <- c("ID", "Indice", "Valor")

ggplot(datos.long, aes(x = Valor)) +
  geom_histogram() +
  facet_wrap(~ Indice) +
  labs(y = "Frecuencia")

ggplot(datos.long, aes(x = Valor)) +
  geom_density(aes(color = Indice)) +
  labs(y = "Densidad")
```

Matriz de correlaciones

```{r, error=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
library("psych")

mat.corr.pearson <- cor(na.omit(datos[,c(1:20)]), method = "pearson", use = "complete.obs")
cor.plot(mat.corr.pearson, xlas = 2, main = "Pearson", cex.axis = .75)

mat.corr.spearman <- cor(na.omit(datos[,c(1:20)]), method = "spearman", use = "complete.obs")
cor.plot(mat.corr.spearman, xlas = 2, main = "Spearman", cex.axis = .75)
```

## Análisis factorial exploratorio

### Número óptimo de factores

Mediante el método de *Análisis Paralelo* se determinó que el número óptimo de factores es 4, tanto para la media como el percentil 95 de los valores propios de las matrices simuladas:

```{r, warning=FALSE, message=FALSE}
library("paran")
library("relimp", pos = 4)

ind <- na.omit(datos[,c(1:12, 14, 16:20)])
colnames(ind) <- nombre[c(1:12, 14, 16:20)]

pa_mean <- paran(ind, iterations = 1000, centile = 0, all = TRUE, cfa = TRUE,
                 graph = TRUE, color = TRUE, col = "black", lty = 1, legend = FALSE)

pa_p95 <- paran(ind, iterations = 1000, centile = 95, all = TRUE, cfa = TRUE,
                graph = TRUE, color = TRUE, col = "black", lty = 1, legend = FALSE)

# Para verificar si da el mismo resultado
pa_mean <- fa.parallel(ind, fm = "fa", fa = "fa", n.iter = 1000, SMC = TRUE,
                        main = "Análisis paralelo, media")
pa_p95 <- fa.parallel(ind, fm = "fa", fa = "fa", n.iter = 1000, quant = .95, SMC = TRUE,
                       main = "Análisis paralelo, P95")
```

Tabla con los valores:

```{r}
pa_eigen <- cbind(pa_p95$fa.values, pa_mean$fa.sim, pa_p95$fa.sim)
colnames(pa_eigen) <- c("Empíricos", "Media simulada", "P95 simulada")

pa_eigen
```

### Análisis Factorial Exploratorio

```{r, include=FALSE}
segr.5f <- fa(ind, nfactors = 5, residuals = TRUE, rotate = "oblimin", 
              min.err = 0.001, max.iter = 50, fm = "minrank", cor = "cor")
#segr.4f
#segr.4f$fit
#segr.4f$fit.off
#segr.4f$dof
#segr.4f$STATISTIC
#segr.4f$PVAL
#segr.4f$loadings
VCE <- sum(segr.5f$values[c(1:5)])/sum(segr.5f$communalities) ## % varianza comun explicada
VCEF1 <- segr.5f$values[1]/sum(segr.5f$communalities) ## % var comun explicada por F1
VCEF2 <- segr.5f$values[2]/sum(segr.5f$communalities) ## % var comun explicada por F2
VCEF3 <- segr.5f$values[3]/sum(segr.5f$communalities) ## % var comun explicada por F3
VCEF4 <- segr.5f$values[4]/sum(segr.5f$communalities) ## % var comun explicada por F4
VCEF5 <- segr.5f$values[5]/sum(segr.5f$communalities) ## % var comun explicada por F5
```

La varianza común total explicada es de un `r round(100*VCE,1)`%. La varianza común explicada por cada uno de los cuatro factores es la siguiente:

```{r}
tabla.VCE <- cbind(round(100*VCEF1, 1), round(100*VCEF2, 1), round(100*VCEF3, 1),
                   round(100*VCEF4, 1), round(100*VCEF5, 1), round(100*VCE, 1))

colnames(tabla.VCE) <- c("Factor 1", "Factor 2", "Factor 3", "Factor 4", "Factor 5", "Total")
rownames(tabla.VCE) <- c("Porcentaje (%)")

knitr::kable(tabla.VCE)

(segr.5f$Vaccounted*100) %>% round(1)
```

Se obtiene un índice KMO=`r KMO(ind)$MSA`. Los resultados del AFE se muestran en la siguiente tabla:

```{r}
tabla.AFE5F <- cbind(round(segr.5f$loadings, 3), round(segr.5f$communality, 3))
colnames(tabla.AFE5F) <- c("Factor 1", "Factor 2", "Factor 3", "Factor 4", "Factor 5", "Comunalidad")
rownames(tabla.AFE5F) <- nombre[c(1:12, 14, 16:20)]
  
knitr::kable(tabla.AFE5F)
```

Finalmente, se muestra el diagrama de la estructura que presentan los factores:

```{r fig.height=8, fig.width=8}
fa.diagram(segr.5f, cut = .3, digits = 2, marg = c(.5, .2, 1, .1), rsize = .3)
```